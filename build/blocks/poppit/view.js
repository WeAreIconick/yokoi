(()=>{class t{constructor(){this.popups=[],this.isReady=!1,this.visitorType=this.getVisitorType(),this.deviceType=this.getDeviceType(),this.triggeredPopups=new Set,this.scrollDepths=new Map,this.timers=new Map,this.sessionShownPopups=new Set,this.rateLimits=new Map,this.init()}init(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.onReady()):this.onReady()}onReady(){this.isReady=!0,this.findPopups(),this.setupEventListeners(),setTimeout(()=>{this.processPopups()},100),setTimeout(()=>{0===this.popups.length&&(this.findPopups(),this.processPopups())},500)}findPopups(){try{const t=document.querySelectorAll("[data-popup-id]");if(0===t.length){const t=document.querySelectorAll(".poppit-block[data-popup-id]");if(t.length>0)return void t.forEach(t=>{const e=this.extractPopupData(t);e&&this.shouldShowPopup(e)&&this.popups.push(e)})}t.forEach(t=>{const e=this.extractPopupData(t);e&&this.shouldShowPopup(e)&&this.popups.push(e)})}catch(t){}}extractPopupData(t){try{if(!t||!t.dataset||!t.dataset.popupId)return null;const e={id:this.sanitizeString(t.dataset.popupId||""),type:this.sanitizeString(t.dataset.popupType||"modal"),triggerType:this.sanitizeString(t.dataset.triggerType||"time"),triggerDelay:this.sanitizeNumber(t.dataset.triggerDelay,3,0,300),scrollDepth:this.sanitizeNumber(t.dataset.scrollDepth,50,0,100),exitIntent:"true"===t.dataset.exitIntent,targeting:this.parseJSON(t.dataset.targeting,{devices:["desktop","tablet","mobile"],userType:"all"}),allowReset:"true"===t.dataset.allowReset,resetDelay:this.sanitizeNumber(t.dataset.resetDelay,60,1,10080),element:t,shown:!1,timestamp:Date.now()};return!e.id||e.id.length>50?null:e}catch(t){return null}}sanitizeString(t,e=100){return"string"!=typeof t?"":t.trim().substring(0,e)}sanitizeNumber(t,e=0,i=0,s=Number.MAX_SAFE_INTEGER){const o=parseInt(t,10);return isNaN(o)?e:Math.min(Math.max(o,i),s)}parseJSON(t,e={}){try{if(!t)return e;const i=JSON.parse(t);return"object"==typeof i&&null!==i?i:e}catch(t){return e}}getUrlParam(t){return new URLSearchParams(window.location.search).get(t)}shouldShowPopup(t){try{return!!t.targeting.devices.includes(this.deviceType)&&("all"===t.targeting.userType||t.targeting.userType===this.visitorType)&&!this.sessionShownPopups.has(t.id)&&this.checkPopupResetStatus(t)}catch(t){return!1}}checkPopupResetStatus(t){try{const e=`poppit_${t.id}`,i=localStorage.getItem(e);if(!i)return!0;const s=this.parseJSON(i);if(!s.lastShown)return!0;const o=new Date(s.lastShown),r=new Date;return!!t.allowReset&&(r-o)/6e4>=t.resetDelay}catch(t){return!0}}processPopups(){try{this.popups.forEach(t=>{switch(this.clearPopupTriggers(t.id),t.triggerType){case"time":this.setupTimeBasedTrigger(t);break;case"scroll":this.setupScrollTrigger(t);break;case"exit":this.setupExitIntentTrigger(t);break;case"load":setTimeout(()=>this.showPopup(t),100)}})}catch(t){}}clearPopupTriggers(t){this.timers.has(t)&&(clearTimeout(this.timers.get(t)),this.timers.delete(t)),this.triggeredPopups.delete(t),this.scrollDepths.delete(t)}setupTimeBasedTrigger(t){const e=Math.max(1e3*t.triggerDelay,100),i=setTimeout(()=>{this.triggeredPopups.has(t.id)||this.showPopup(t),this.timers.delete(t.id)},e);this.timers.set(t.id,i)}setupScrollTrigger(t){this.scrollDepths.set(t.id,{popup:t,targetDepth:t.scrollDepth,triggered:!1})}setupExitIntentTrigger(t){let e=!1;const i=s=>{e||this.triggeredPopups.has(t.id)||(s.clientY<=0||null===s.relatedTarget&&s.target===document.documentElement)&&(e=!0,this.showPopup(t),document.removeEventListener("mouseleave",i),document.removeEventListener("mousemove",o))};let s=0;const o=r=>{e||this.triggeredPopups.has(t.id)||(r.clientY<100&&s>r.clientY+50&&(e=!0,this.showPopup(t),document.removeEventListener("mouseleave",i),document.removeEventListener("mousemove",o)),s=r.clientY)};document.addEventListener("mouseleave",i),document.addEventListener("mousemove",o)}setupEventListeners(){try{let t;window.addEventListener("scroll",()=>{clearTimeout(t),t=setTimeout(()=>{this.handleScroll()},100)},{passive:!0}),document.addEventListener("click",t=>{t.target&&(t.target.classList.contains("popup-close")||t.target.classList.contains("popup-overlay")&&t.target===t.currentTarget)&&(t.preventDefault(),this.closePopup(t.target.closest(".popup-overlay")))}),document.addEventListener("keydown",t=>{"Escape"===t.key&&this.closeAllPopups()}),document.addEventListener("submit",t=>{t.target&&t.target.classList.contains("popup-email-form")&&(t.preventDefault(),this.handleEmailSubmission(t.target))})}catch(t){}}handleScroll(){try{const t=window.pageYOffset||document.documentElement.scrollTop,e=document.body.scrollHeight-window.innerHeight,i=e>0?t/e*100:0;this.scrollDepths.forEach((t,e)=>{!t.triggered&&!this.triggeredPopups.has(e)&&i>=t.targetDepth&&(t.triggered=!0,this.showPopup(t.popup),this.scrollDepths.delete(e))})}catch(t){}}showPopup(t){try{if(t.shown||this.triggeredPopups.has(t.id))return;this.triggeredPopups.add(t.id),this.sessionShownPopups.add(t.id),t.shown=!0,this.timers.has(t.id)&&(clearTimeout(this.timers.get(t.id)),this.timers.delete(t.id));const e=this.createPopupHTML(t);document.body.insertAdjacentHTML("beforeend",e);const i=document.getElementById(`popup-${t.id}`);i&&(i.offsetHeight,window.requestAnimationFrame(()=>{i.classList.add("popup-active")})),this.trackEvent(t.id,"display");try{const e=`poppit_${t.id}`,i={lastShown:(new Date).toISOString(),showCount:this.getShowCount(t.id)+1};localStorage.setItem(e,JSON.stringify(i))}catch(t){}}catch(t){}}getShowCount(t){try{const e=`poppit_${t}`,i=localStorage.getItem(e);if(i)return this.parseJSON(i).showCount||0}catch(t){}return 0}createPopupHTML(t){try{const e=t.element;if(!e)return"";const i=e.querySelector(".popup-title"),s=e.querySelector(".popup-text"),o=i?this.sanitizeHTML(i.innerHTML):"",r=s?this.sanitizeHTML(s.innerHTML):"",a="true"===e.dataset.emailEnabled,n=this.sanitizeString(e.dataset.emailPlaceholder||"Enter your email",100),p=this.sanitizeString(e.dataset.buttonText||"Subscribe",50),u="false"!==e.dataset.showCloseButton,c=this.sanitizeNumber(100*e.dataset.overlayOpacity,80,0,100)/100;return`\n\t\t\t\t<div class="popup-overlay animation-${this.sanitizeString(e.dataset.animation||"fadeIn",20)}" id="popup-${t.id}" style="background: rgba(0, 0, 0, ${c})">\n\t\t\t\t\t<div class="popup-container popup-${t.type}" role="dialog" aria-modal="true" aria-labelledby="popup-title-${t.id}">\n\t\t\t\t\t\t${u?'<button class="popup-close" aria-label="Close popup">Ã—</button>':""}\n\t\t\t\t\t\t<div class="popup-content">\n\t\t\t\t\t\t\t${o?`<h3 class="popup-title" id="popup-title-${t.id}">${o}</h3>`:""}\n\t\t\t\t\t\t\t${r?`<div class="popup-text">${r}</div>`:""}\n\t\t\t\t\t\t\t${a?`\n\t\t\t\t\t\t\t\t<form class="popup-email-form" data-popup-id="${t.id}" novalidate>\n\t\t\t\t\t\t\t\t\t<input type="email" class="popup-email-input" placeholder="${n}" required autocomplete="email" maxlength="254">\n\t\t\t\t\t\t\t\t\t<button type="submit" class="popup-submit-btn">${p}</button>\n\t\t\t\t\t\t\t\t</form>\n\t\t\t\t\t\t\t`:""}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`}catch(t){return""}}sanitizeHTML(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}closePopup(t){try{if(!t)return;t.classList.remove("popup-active"),setTimeout(()=>{t.parentNode&&t.remove()},300);const e=t.id.replace("popup-","");e&&this.trackEvent(e,"close")}catch(t){}}closeAllPopups(){try{document.querySelectorAll(".popup-overlay.popup-active").forEach(t=>this.closePopup(t))}catch(t){}}handleEmailSubmission(t){try{const e=t.querySelector('input[type="email"]'),i=t.querySelector(".popup-submit-btn"),s=this.sanitizeString(t.dataset.popupId||"");if(!e||!i||!s)return;const o=e.value.trim();if(!this.isValidEmail(o))return void this.showFormError(t,"Please enter a valid email address.");if(this.isRateLimited("email",s))return void this.showFormError(t,"Please wait before submitting again.");const r=i.textContent;if(i.disabled=!0,i.textContent="Submitting...",this.clearFormError(t),"undefined"!=typeof poppitAjax&&poppitAjax.ajaxurl){const e=new FormData;e.append("action","poppit_email"),e.append("nonce",poppitAjax.nonce),e.append("email",o),e.append("popup_id",s),e.append("page_url",window.location.href),fetch(poppitAjax.ajaxurl,{method:"POST",body:e,credentials:"same-origin"}).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}).then(e=>{if(!e||!e.success)throw new Error(e?.data||"Submission failed");t.innerHTML='<div class="popup-success">Thank you for subscribing!</div>',this.trackEvent(s,"email_submit"),setTimeout(()=>{this.closePopup(document.getElementById(`popup-${s}`))},2e3)}).catch(e=>{i.disabled=!1,i.textContent=r,this.showFormError(t,"Something went wrong. Please try again.")})}else t.innerHTML='<div class="popup-success">Thank you for subscribing!</div>',setTimeout(()=>{this.closePopup(document.getElementById(`popup-${s}`))},2e3)}catch(t){}}isValidEmail(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)&&t.length<=254}isRateLimited(t,e){const i=`${t}_${e}`,s=Date.now(),o=this.rateLimits.get(i);return!!(o&&s-o.lastAction<o.cooldown)||(this.rateLimits.set(i,{lastAction:s,cooldown:2e3}),!1)}showFormError(t,e){this.clearFormError(t);const i=document.createElement("div");i.className="popup-error",i.textContent=e,t.appendChild(i)}clearFormError(t){const e=t.querySelector(".popup-error");e&&e.remove()}trackEvent(t,e){try{if("undefined"!=typeof poppitAjax&&poppitAjax.ajaxurl){if(this.isRateLimited("track",t))return;const i=new FormData;i.append("action","poppit_track"),i.append("nonce",poppitAjax.nonce),i.append("popup_id",t),i.append("event_type",e),i.append("page_url",window.location.href),fetch(poppitAjax.ajaxurl,{method:"POST",body:i,credentials:"same-origin"}).catch(()=>{})}}catch(t){}}getVisitorType(){try{return localStorage.getItem("poppit_visited")?"returning":(localStorage.setItem("poppit_visited","true"),"new")}catch(t){return"new"}}getDeviceType(){const t=window.innerWidth;return t<=768?"mobile":t<=1024?"tablet":"desktop"}}try{new t}catch(t){}})();