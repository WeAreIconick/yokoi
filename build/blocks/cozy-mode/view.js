(()=>{"use strict";const t=class{constructor(t){this.doc=t,this.article=null}parse(){try{const t=["article",".entry-content",".post-content",".content","#content","main",".main-content",".article-content"];let e=null;for(const o of t)if(e=this.doc.querySelector(o),e)break;e||(e=this.doc.body);return{title:this.getTitle(),content:this.cleanContent(e),textContent:e?e.textContent:"",length:e?e.textContent.length:0}}catch(t){return console.error("Readability parsing error:",t),null}}getTitle(){const t=["h1",".entry-title",".post-title",".page-title","title"];for(const e of t){const t=this.doc.querySelector(e);if(t&&t.textContent.trim())return t.textContent.trim()}return this.doc.title||"Untitled"}cleanContent(t){if(!t)return"";const e=t.cloneNode(!0);return["nav","header","footer",".navigation",".nav",".menu",".sidebar",".widget",".advertisement",".ad",".social-share",".comments",".comment","noscript","script","style","iframe","object","embed"].forEach(t=>{e.querySelectorAll(t).forEach(t=>t.remove())}),this.cleanAttributes(e),e.innerHTML}cleanAttributes(t){const e=["onclick","onload","onerror","onmouseover","onmouseout","onfocus","onblur","onchange","onsubmit"];t.querySelectorAll("*").forEach(t=>{e.forEach(e=>{t.hasAttribute(e)&&t.removeAttribute(e)})})}};(()=>{if("undefined"==typeof window)return;const e=window.cozyMode;if(e){class o{constructor(){this.modal=null,this.backdrop=null,this.container=null,this.title=null,this.content=null,this.loading=null,this.closeButton=null,this.controls=null,this.isActive=!1,this.focusableElements=[],this.firstFocusableElement=null,this.lastFocusableElement=null,this.previousActiveElement=null,this.currentFontSize=18,this.isDarkMode=!1,this.retryCount=0,this.maxRetries=3,this.init()}init(){this.loadPreferences(),this.bindEvents(),this.setupElements(),this.setupPerformanceMonitoring()}setupPerformanceMonitoring(){"performance"in window&&(this.performanceStart=performance.now())}loadPreferences(){try{const t=localStorage.getItem("cozyModePreferences");if(t){const e=JSON.parse(t);this.currentFontSize=e.fontSize||18,this.isDarkMode=e.darkMode||!1}}catch(t){console.warn("Cozy Mode: Could not load preferences:",t)}}savePreferences(){try{const t={fontSize:this.currentFontSize,darkMode:this.isDarkMode,lastUsed:(new Date).toISOString(),version:e.version||"1.0.0"};localStorage.setItem("cozyModePreferences",JSON.stringify(t))}catch(t){console.warn("Cozy Mode: Could not save preferences:",t)}}bindEvents(){document.addEventListener("click",t=>{t.target.closest(".cozy-mode-toggle")&&(t.preventDefault(),this.handleToggleClick(t))}),document.addEventListener("click",t=>{t.target.closest(".cozy-mode-close")&&(t.preventDefault(),this.closeModal())}),document.addEventListener("click",t=>{this.isActive&&this.modal&&(t.target.closest(".cozy-mode-toggle")||t.target.classList.contains("cozy-mode-click-overlay")&&this.closeModal())}),document.addEventListener("keydown",t=>{"Escape"===t.key&&this.isActive&&this.closeModal()}),document.addEventListener("click",t=>{const e=t.target.closest(".cozy-mode-control");e&&(t.preventDefault(),e.classList.contains("cozy-mode-font-decrease")?this.decreaseFontSize():e.classList.contains("cozy-mode-font-reset")?this.resetFontSize():e.classList.contains("cozy-mode-font-increase")?this.increaseFontSize():e.classList.contains("cozy-mode-theme-toggle")?this.toggleTheme():e.classList.contains("cozy-mode-print")&&this.printArticle())}),document.addEventListener("keydown",t=>{this.isActive&&"Tab"===t.key&&this.handleTabKey(t)}),window.addEventListener("resize",this.debounce(()=>{this.handleResize()},250))}handleToggleClick(t){const e=t.target.closest(".cozy-mode-toggle"),o=e?.dataset.postId;o?(this.setButtonLoading(e,!0),this.openModalWithRetry()):console.error("Cozy Mode: Post ID not found")}setButtonLoading(t,e){if(e){t.disabled=!0,t.classList.add("loading");const e=t.querySelector(".cozy-mode-icon");e&&(e.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>')}else{t.disabled=!1,t.classList.remove("loading");const e=t.querySelector(".cozy-mode-icon");e&&(e.innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6H20M4 12H20M4 18H14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>')}}async openModalWithRetry(){try{await this.openModal(),this.retryCount=0}catch(t){this.retryCount+=1,this.retryCount<this.maxRetries?(console.warn(`Cozy Mode: Retry ${this.retryCount}/${this.maxRetries}`),setTimeout(()=>this.openModalWithRetry(),1e3*this.retryCount)):(console.error("Cozy Mode: Max retries exceeded"),this.showError("Maximum retry attempts exceeded. Please refresh the page."))}}setupElements(){this.modal=document.getElementById("cozy-mode-modal"),this.backdrop=this.modal?.querySelector(".cozy-mode-backdrop"),this.container=this.modal?.querySelector(".cozy-mode-container"),this.content=this.modal?.querySelector(".cozy-mode-article"),this.loading=this.modal?.querySelector(".cozy-mode-loading"),this.closeButton=this.modal?.querySelector(".cozy-mode-close"),this.controls=this.modal?.querySelector(".cozy-mode-controls"),this.modal&&this.content?this.updateFocusableElements():console.error("Cozy Mode: Required elements not found")}debounce(t,e){let o;return function(...n){clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),t(...n)},e)}}handleResize(){this.isActive&&this.updateFocusableElements()}updateFocusableElements(){this.modal&&(this.focusableElements=Array.from(this.modal.querySelectorAll(["button:not([disabled])","[href]","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(", "))),this.firstFocusableElement=this.focusableElements[0],this.lastFocusableElement=this.focusableElements[this.focusableElements.length-1])}handleTabKey(t){this.isActive&&(t.shiftKey?document.activeElement===this.firstFocusableElement&&(t.preventDefault(),this.lastFocusableElement?.focus()):document.activeElement===this.lastFocusableElement&&(t.preventDefault(),this.firstFocusableElement?.focus()))}async openModal(){try{this.previousActiveElement=document.activeElement,this.showModal(),this.showLoadingState();const t=await Promise.race([this.extractContent(),this.timeoutPromise(1e4)]);if(!t)throw new Error("Content extraction failed or timed out");this.populateModal(t),this.hideLoadingState(),this.updateFocusableElements(),this.firstFocusableElement?.focus(),this.logPerformanceMetrics(),document.querySelectorAll(".cozy-mode-toggle").forEach(t=>this.setButtonLoading(t,!1))}catch(t){throw console.error("Cozy Mode: Error opening modal:",t),this.hideLoadingState(),this.showError(t.message||"An error occurred while loading content"),document.querySelectorAll(".cozy-mode-toggle").forEach(t=>this.setButtonLoading(t,!1)),t}}timeoutPromise(t){return new Promise((e,o)=>{setTimeout(()=>o(new Error("Operation timed out")),t)})}showLoadingState(){this.loading&&(this.loading.style.display="block"),this.content&&(this.content.style.display="none")}hideLoadingState(){this.loading&&(this.loading.style.display="none"),this.content&&(this.content.style.display="block")}logPerformanceMetrics(){if("performance"in window&&this.performanceStart){const t=performance.now()-this.performanceStart;console.log(`Cozy Mode: Modal loaded in ${t.toFixed(2)}ms`),void 0!==window.gtag&&window.gtag("event","cozy_mode_load_time",{value:Math.round(t),event_category:"performance"})}}async extractContent(){try{const e=document.cloneNode(!0);e.querySelectorAll(".cozy-mode-button-container").forEach(t=>t.remove());const o=new t(e).parse();if(!o)throw new Error("Readability.js could not parse content");return o}catch(t){return console.error("Cozy Mode: Content extraction failed:",t),null}}populateModal(t){if(!this.modal||!this.content)return;(this.modal.querySelector(".cozy-mode-title")||this.createTitle()).textContent=t.title||e.strings?.readingMode||"Reading Mode",this.content.innerHTML="";const o=document.createElement("div");o.className="cozy-mode-article-content",o.innerHTML=t.content||"",this.enhanceContent(o),this.content.appendChild(o),this.applyStoredPreferences(o),this.setupAnalytics(t),this.setupSecurity(o),this.injectFooter(t),this.setupMutationObserver(o),this.setupAccessibility()}createTitle(){const t=this.modal?.querySelector(".cozy-mode-header");if(!t)return null;const e=document.createElement("h1");return e.className="cozy-mode-title",e.id="cozy-mode-title",t.insertBefore(e,t.firstChild),e}enhanceContent(t){t.querySelectorAll("img").forEach(t=>{t.loading="lazy",t.decoding="async",t.classList.add("cozy-mode-image"),t.addEventListener("error",()=>{t.classList.add("cozy-mode-image-error")})}),t.querySelectorAll("a").forEach(t=>{t.target="_blank",t.rel="noopener noreferrer nofollow",t.classList.add("cozy-mode-link"),t.addEventListener("click",()=>{this.trackLinkClick(t.href)})}),Array.from({length:3},(e,o)=>t.querySelectorAll(`h${o+2}`)).forEach(t=>{t.forEach(t=>{t.classList.add("cozy-mode-heading")})}),t.querySelectorAll("p").forEach(t=>{t.classList.add("cozy-mode-paragraph")})}applyStoredPreferences(t){t&&(t.style.fontSize=`${this.currentFontSize}px`,this.isDarkMode?this.modal?.classList.add("cozy-mode-dark"):this.modal?.classList.remove("cozy-mode-dark"))}setupAnalytics(t){void 0!==window.gtag&&window.gtag("event","cozy_mode_open",{event_category:"engagement",event_label:t.title||""})}setupSecurity(t){t.querySelectorAll("script").forEach(t=>t.remove()),t.querySelectorAll("a").forEach(t=>{t.addEventListener("click",e=>{const o=new URL(t.href,window.location.href);this.isTrustedDomain(o.hostname)||(e.preventDefault(),window.open(o.href,"_blank","noopener,noreferrer"))})})}isTrustedDomain(t){const o=[window.location.hostname];return Array.isArray(e.trustedDomains)&&e.trustedDomains.length>0&&o.push(...e.trustedDomains),o.includes(t)}injectFooter(t){if(!this.content)return;const o=document.createElement("footer");o.className="cozy-mode-footer";const n=e.strings?.enterCozyMode||"Enter Cozy Mode",s=e.strings?.toggleDarkMode||"Toggle dark mode",i=e.strings?.print||"Print article";o.innerHTML=`\n\t\t\t\t<div class="cozy-mode-footer-meta">\n\t\t\t\t\t<p>${this.escapeHTML(t.title||"")}</p>\n\t\t\t\t\t<p>${this.escapeHTML(n)}</p>\n\t\t\t\t</div>\n\t\t\t\t<div class="cozy-mode-footer-actions">\n\t\t\t\t\t<button type="button" class="cozy-mode-control cozy-mode-theme-toggle" aria-label="${this.escapeHTML(s)}">üåô</button>\n\t\t\t\t\t<button type="button" class="cozy-mode-control cozy-mode-print" aria-label="${this.escapeHTML(i)}">üñ®Ô∏è</button>\n\t\t\t\t</div>\n\t\t\t`,this.content.appendChild(o)}setupMutationObserver(t){t&&"undefined"!=typeof MutationObserver&&new MutationObserver(()=>{t.querySelectorAll("img").forEach(t=>{t.loading="lazy"})}).observe(t,{childList:!0,subtree:!0})}setupAccessibility(){this.modal&&(this.modal.setAttribute("aria-hidden","false"),this.modal.setAttribute("role","dialog"),this.modal.setAttribute("aria-modal","true"),this.modal.setAttribute("aria-label",e.strings?.readingMode||"Reading Mode"),this.modal.setAttribute("tabindex","-1"),this.closeButton&&this.closeButton.setAttribute("aria-label",e.strings?.closeCozyMode||"Close Cozy Mode"),this.controls)&&(this.controls.setAttribute("role","toolbar"),this.controls.querySelectorAll("button").forEach(t=>{t.setAttribute("tabindex","0")}))}handleResizeObserver(){"ResizeObserver"in window&&this.content&&new ResizeObserver(()=>{const t=Math.min(.9*window.innerHeight,800);this.content.style.maxHeight=`${t}px`}).observe(this.content)}handlePrefersReducedMotion(){if(!this.modal)return;const t=window.matchMedia("(prefers-reduced-motion: reduce)"),e=()=>{t.matches?this.modal.classList.add("cozy-mode-reduced-motion"):this.modal.classList.remove("cozy-mode-reduced-motion")};t.addEventListener("change",e),e()}showModal(){this.modal&&(this.modal.hidden=!1,this.modal.classList.add("active"),this.createClickOverlay(),document.body.classList.add("cozy-mode-open"),this.isActive=!0,this.handlePrefersReducedMotion(),this.handleResizeObserver(),this.trackEvent("open"))}createClickOverlay(){if(!this.modal||this.modal.parentElement?.querySelector(".cozy-mode-click-overlay"))return;const t=document.createElement("div");t.className="cozy-mode-click-overlay",this.modal.parentElement.insertBefore(t,this.modal)}closeModal(){if(!this.modal)return;this.modal.classList.remove("active"),this.modal.setAttribute("aria-hidden","true");const t=this.modal.parentElement?.querySelector(".cozy-mode-click-overlay");t&&t.remove(),setTimeout(()=>{this.modal&&(this.modal.hidden=!0)},300),document.body.classList.remove("cozy-mode-open"),this.isActive=!1,this.savePreferences(),this.trackEvent("close"),this.previousActiveElement instanceof HTMLElement&&this.previousActiveElement.focus()}decreaseFontSize(){this.currentFontSize=Math.max(14,this.currentFontSize-2),this.applyFontSize(),this.trackEvent("font_decrease"),this.savePreferences()}increaseFontSize(){this.currentFontSize=Math.min(28,this.currentFontSize+2),this.applyFontSize(),this.trackEvent("font_increase"),this.savePreferences()}resetFontSize(){this.currentFontSize=18,this.applyFontSize(),this.trackEvent("font_reset"),this.savePreferences()}applyFontSize(){const t=this.modal?.querySelector(".cozy-mode-article-content");t&&(t.style.fontSize=`${this.currentFontSize}px`)}toggleTheme(){this.isDarkMode=!this.isDarkMode,this.modal&&this.modal.classList.toggle("cozy-mode-dark",this.isDarkMode),this.trackEvent(this.isDarkMode?"dark_mode_on":"dark_mode_off"),this.savePreferences()}printArticle(){const t=window.open("","_blank");if(!t)return;const o=this.modal?.querySelector(".cozy-mode-article-content");t.document.write(`\n\t\t\t\t<!DOCTYPE html>\n\t\t\t\t<html>\n\t\t\t\t\t<head>\n\t\t\t\t\t\t<title>${this.escapeHTML(e.strings?.readingMode||"Reading Mode")}</title>\n\t\t\t\t\t\t<style>\n\t\t\t\t\t\t\tbody { font-family: Georgia, serif; margin: 40px; }\n\t\t\t\t\t\t\timg { max-width: 100%; height: auto; }\n\t\t\t\t\t\t</style>\n\t\t\t\t\t</head>\n\t\t\t\t\t<body>\n\t\t\t\t\t\t${o?.innerHTML||""}\n\t\t\t\t\t</body>\n\t\t\t\t</html>\n\t\t\t`),t.document.close(),t.focus(),t.print(),this.trackEvent("print")}trackEvent(t){void 0!==window.gtag&&window.gtag("event",`cozy_mode_${t}`,{event_category:"engagement"})}trackLinkClick(t){void 0!==window.gtag&&window.gtag("event","cozy_mode_link_click",{event_category:"engagement",event_label:t})}showError(t){if(!this.modal)return;this.hideLoadingState();const o=this.modal.querySelector(".cozy-mode-error")||this.createErrorContainer();o.innerHTML=`\n\t\t\t\t<div class="cozy-mode-error-content">\n\t\t\t\t\t<p>${this.escapeHTML(t||e.strings?.error||"An error occurred.")}</p>\n\t\t\t\t\t<button type="button" class="cozy-mode-control cozy-mode-close-error">\n\t\t\t\t\t\t${this.escapeHTML(e.strings?.closeCozyMode||"Close Cozy Mode")}\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t`,o.style.display="block";const n=o.querySelector(".cozy-mode-close-error");n&&n.addEventListener("click",()=>{o.style.display="none",this.closeModal()})}createErrorContainer(){if(!this.modal)return null;const t=document.createElement("div");return t.className="cozy-mode-error",this.modal.appendChild(t),t}showModalError(t){this.showError(t)}escapeHTML(t){return t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new o}):new o}else console.error("Cozy Mode: Localized data is not available")})()})();