(()=>{"use strict";const e=class{constructor(e){this.doc=e,this.article=null}parse(){try{const e=["article",".entry-content",".post-content",".content","#content","main",".main-content",".article-content"];let t=null;for(const o of e)if(t=this.doc.querySelector(o),t)break;t||(t=this.doc.body);return{title:this.getTitle(),content:this.cleanContent(t),textContent:t?t.textContent:"",length:t?t.textContent.length:0}}catch(e){return null}}getTitle(){const e=["h1",".entry-title",".post-title",".page-title","title"];for(const t of e){const e=this.doc.querySelector(t);if(e&&e.textContent.trim())return e.textContent.trim()}return this.doc.title||"Untitled"}cleanContent(e){if(!e)return"";const t=e.cloneNode(!0);return["nav","header","footer",".navigation",".nav",".menu",".sidebar",".widget",".advertisement",".ad",".social-share",".comments",".comment","noscript","script","style","iframe","object","embed"].forEach(e=>{t.querySelectorAll(e).forEach(e=>e.remove())}),this.cleanAttributes(t),t.innerHTML}cleanAttributes(e){const t=["onclick","onload","onerror","onmouseover","onmouseout","onfocus","onblur","onchange","onsubmit"];e.querySelectorAll("*").forEach(e=>{t.forEach(t=>{e.hasAttribute(t)&&e.removeAttribute(t)})})}};class t{constructor(){this.modal=null,this.backdrop=null,this.container=null,this.title=null,this.content=null,this.loading=null,this.closeButton=null,this.controls=null,this.isActive=!1,this.focusableElements=[],this.firstFocusableElement=null,this.lastFocusableElement=null,this.previousActiveElement=null,this.currentFontSize=18,this.retryCount=0,this.maxRetries=3,this.init()}init(){this.loadPreferences(),this.bindEvents(),this.setupElements(),this.setupPerformanceMonitoring()}setupPerformanceMonitoring(){"performance"in window&&(this.performanceStart=performance.now())}loadPreferences(){try{const e=localStorage.getItem("cozyModePreferences");if(e){const t=JSON.parse(e);this.currentFontSize=t.fontSize||18}}catch(e){}}savePreferences(){try{const e={fontSize:this.currentFontSize,lastUsed:(new Date).toISOString(),version:window.cozyMode?.version||"1.0.0"};localStorage.setItem("cozyModePreferences",JSON.stringify(e))}catch(e){}}bindEvents(){document.addEventListener("click",e=>{if(e.target.closest(".cozy-mode-toggle"))return e.preventDefault(),void this.handleToggleClick(e);if(e.target.closest(".cozy-mode-close"))return e.preventDefault(),void this.closeModal();const t=e.target.closest(".cozy-mode-control");if(t){if(e.preventDefault(),t.classList.contains("cozy-mode-font-decrease"))this.decreaseFontSize();else if(t.classList.contains("cozy-mode-font-reset"))this.resetFontSize();else if(t.classList.contains("cozy-mode-font-increase"))this.increaseFontSize();else if(t.classList.contains("cozy-mode-close-error")){const e=t.closest(".cozy-mode-error");e&&(e.style.display="none",this.closeModal())}}else(this.isActive&&this.modal&&e.target.classList.contains("cozy-mode-click-overlay")||this.isActive&&this.backdrop&&e.target===this.backdrop)&&this.closeModal()},{passive:!1}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isActive?this.closeModal():this.isActive&&"Tab"===e.key&&this.handleTabKey(e)},{passive:!0}),window.addEventListener("resize",this.debounce(()=>{this.handleResize()},250),{passive:!0})}handleToggleClick(e){const t=e.target.closest(".cozy-mode-toggle"),o=t?.dataset.postId;o&&(this.setButtonLoading(t,!0),this.openModalWithRetry())}setButtonLoading(e,t){if(t){e.disabled=!0,e.classList.add("loading");const t=e.querySelector(".cozy-mode-icon");if(t){t.textContent="";const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("width","18"),e.setAttribute("height","18"),e.setAttribute("viewBox","0 0 24 24"),e.setAttribute("fill","none");const o=document.createElementNS("http://www.w3.org/2000/svg","circle");o.setAttribute("cx","12"),o.setAttribute("cy","12"),o.setAttribute("r","10"),o.setAttribute("stroke","currentColor"),o.setAttribute("stroke-width","2");const n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d","M12 6v6l4 2"),n.setAttribute("stroke","currentColor"),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-linecap","round"),e.appendChild(o),e.appendChild(n),t.appendChild(e)}}else{e.disabled=!1,e.classList.remove("loading");const t=e.querySelector(".cozy-mode-icon");if(t){t.textContent="";const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("width","18"),e.setAttribute("height","18"),e.setAttribute("viewBox","0 0 24 24"),e.setAttribute("fill","none");const o=document.createElementNS("http://www.w3.org/2000/svg","path");o.setAttribute("d","M4 6H20M4 12H20M4 18H14"),o.setAttribute("stroke","currentColor"),o.setAttribute("stroke-width","2"),o.setAttribute("stroke-linecap","round"),o.setAttribute("stroke-linejoin","round"),e.appendChild(o),t.appendChild(e)}}}async openModalWithRetry(){try{await this.openModal(),this.retryCount=0}catch(e){this.retryCount+=1,this.retryCount<this.maxRetries?setTimeout(()=>this.openModalWithRetry(),1e3*this.retryCount):this.showError("Maximum retry attempts exceeded. Please refresh the page.")}}setupElements(){const e=document.querySelectorAll("#cozy-mode-modal");if(e.length>1)for(let t=1;t<e.length;t++)e[t].remove();this.modal=document.getElementById("cozy-mode-modal"),this.modal&&(this.backdrop=this.modal?.querySelector(".cozy-mode-backdrop"),this.container=this.modal?.querySelector(".cozy-mode-container"),this.content=this.modal?.querySelector(".cozy-mode-content")||this.modal?.querySelector(".cozy-mode-article"),this.loading=this.modal?.querySelector(".cozy-mode-loading"),this.closeButton=this.modal?.querySelector(".cozy-mode-close"),this.controls=this.modal?.querySelector(".cozy-mode-controls"),this.backdrop&&(this.backdrop.style.cursor="pointer"),this.content&&this.updateFocusableElements())}debounce(e,t){let o;return function(...n){clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),e(...n)},t)}}handleResize(){this.isActive&&this.updateFocusableElements()}updateFocusableElements(){this.modal&&(this.focusableElements=Array.from(this.modal.querySelectorAll(["button:not([disabled])","[href]","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(", "))),this.firstFocusableElement=this.focusableElements[0],this.lastFocusableElement=this.focusableElements[this.focusableElements.length-1])}handleTabKey(e){this.isActive&&(e.shiftKey?document.activeElement===this.firstFocusableElement&&(e.preventDefault(),this.lastFocusableElement?.focus()):document.activeElement===this.lastFocusableElement&&(e.preventDefault(),this.firstFocusableElement?.focus()))}async openModal(){try{if(this.modal&&this.content||this.setupElements(),!this.modal){const e=document.querySelectorAll("#cozy-mode-modal");if(e.length>1)for(let t=1;t<e.length;t++)e[t].remove();this.modal=document.getElementById("cozy-mode-modal")}if(!this.modal)throw new Error("Cozy Mode modal not found. Please ensure the Cozy Mode block is present on the page.");if(this.setupElements(),!this.content)throw new Error("Cozy Mode content container not found.");this.previousActiveElement=document.activeElement,this.showModal(),this.showLoadingState();const e=await Promise.race([this.extractContent(),this.timeoutPromise(1e4)]);if(!e)throw new Error("Content extraction failed or timed out");this.populateModal(e),this.hideLoadingState(),this.updateFocusableElements(),this.firstFocusableElement?.focus(),this.logPerformanceMetrics(),document.querySelectorAll(".cozy-mode-toggle").forEach(e=>this.setButtonLoading(e,!1))}catch(e){throw this.hideLoadingState(),this.showError(e.message||"An error occurred while loading content"),document.querySelectorAll(".cozy-mode-toggle").forEach(e=>this.setButtonLoading(e,!1)),e}}timeoutPromise(e){return new Promise((t,o)=>{setTimeout(()=>o(new Error("Operation timed out")),e)})}showLoadingState(){this.loading&&(this.loading.style.display="block"),this.content&&(this.content.style.display="none")}hideLoadingState(){this.loading&&(this.loading.style.display="none"),this.content&&(this.content.style.display="block")}logPerformanceMetrics(){if("performance"in window&&this.performanceStart){const e=performance.now()-this.performanceStart;void 0!==window.gtag&&window.gtag("event","cozy_mode_load_time",{value:Math.round(e),event_category:"performance"})}}async extractContent(){try{const t=document.cloneNode(!0);t.querySelectorAll(".cozy-mode-button-container").forEach(e=>e.remove()),t.querySelectorAll(".yokoi-cozy-mode-block").forEach(e=>{const t=document.createElement("div");for(;e.firstChild;)t.appendChild(e.firstChild);e.parentNode?.replaceChild(t,e)}),t.querySelectorAll(".cozy-mode-modal").forEach(e=>e.remove()),t.querySelectorAll(".cozy-mode-button-container, .cozy-mode-toggle, .cozy-mode-modal, .cozy-mode-backdrop, .cozy-mode-container, .cozy-mode-header, .cozy-mode-controls, .cozy-mode-control").forEach(e=>e.remove());const o=new e(t).parse();if(!o)throw new Error("Readability.js could not parse content");return o}catch(e){return null}}populateModal(e){if(!this.modal||!this.content)return;if(!e||!e.content)return void this.showError("Unable to extract content. Please try refreshing the page.");const t=this.modal.querySelector(".cozy-mode-title")||this.createTitle();t&&(t.textContent=e.title||window.cozyMode?.strings?.readingMode||"Reading Mode"),this.content.textContent="";const o=document.createElement("div");o.className="cozy-mode-article-content";const n=document.createElement("div");for(n.innerHTML=e.content,[".cozy-mode-button-container",".cozy-mode-toggle",".yokoi-cozy-mode-block",".cozy-mode-modal",".cozy-mode-backdrop",".cozy-mode-container",".cozy-mode-header",".cozy-mode-title",".cozy-mode-close",".cozy-mode-content",".cozy-mode-loading",".cozy-mode-spinner",".cozy-mode-article",".cozy-mode-controls",".cozy-mode-control",'[class*="cozy-mode"]','[id*="cozy-mode"]'].forEach(e=>{try{n.querySelectorAll(e).forEach(e=>e.remove())}catch(e){}}),n.querySelectorAll('script, iframe, object, embed, form, input, button[type="submit"]').forEach(e=>e.remove()),n.querySelectorAll("*").forEach(e=>{Array.from(e.attributes).forEach(t=>{t.name.startsWith("on")&&e.removeAttribute(t.name)})});n.firstChild;)o.appendChild(n.firstChild);if(!o.hasChildNodes()||""===o.textContent.trim()){const t=document.createElement("div");for(t.innerHTML=e.content;t.firstChild;)o.appendChild(t.firstChild)}o.querySelectorAll('.cozy-mode-button-container, .cozy-mode-toggle, .yokoi-cozy-mode-block, [id*="cozy-mode"]').forEach(e=>e.remove()),this.enhanceContent(o);const i=this.content.querySelector(".cozy-mode-article");i?i.appendChild(o):this.content.appendChild(o),this.applyStoredPreferences(o),this.setupAnalytics(e),this.setupSecurity(o),this.setupMutationObserver(o),this.setupAccessibility(),this.applyFontSize()}createTitle(){const e=this.modal?.querySelector(".cozy-mode-header");if(!e)return null;const t=document.createElement("h1");return t.className="cozy-mode-title",t.id="cozy-mode-title",e.insertBefore(t,e.firstChild),t}enhanceContent(e){e.querySelectorAll("img").forEach(e=>{e.loading="lazy",e.decoding="async",e.classList.add("cozy-mode-image"),e.addEventListener("error",()=>{e.classList.add("cozy-mode-image-error")},{passive:!0,once:!0})}),e.querySelectorAll("a").forEach(e=>{try{new URL(e.href,window.location.href).hostname!==window.location.hostname&&(e.target="_blank",e.rel="noopener noreferrer nofollow")}catch(t){e.removeAttribute("href")}e.classList.add("cozy-mode-link"),e.addEventListener("click",()=>{this.trackLinkClick(e.href)},{passive:!0})}),e.querySelectorAll("h2, h3, h4").forEach(e=>{e.classList.add("cozy-mode-heading")}),e.querySelectorAll("p").forEach(e=>{e.classList.add("cozy-mode-paragraph")})}applyStoredPreferences(e){}setupAnalytics(e){void 0!==window.gtag&&window.gtag("event","cozy_mode_open",{event_category:"engagement",event_label:e.title||""})}setupSecurity(e){["script","iframe","object","embed","form",'input[type="submit"]','button[type="submit"]'].forEach(t=>{e.querySelectorAll(t).forEach(e=>e.remove())}),e.querySelectorAll("*").forEach(e=>{Array.from(e.attributes).forEach(t=>{t.name.startsWith("on")&&t.name.length>2&&e.removeAttribute(t.name),"href"!==t.name&&"src"!==t.name||!t.value.trim().toLowerCase().startsWith("javascript:")||e.removeAttribute(t.name)})}),e.querySelectorAll("a").forEach(e=>{e.addEventListener("click",t=>{try{const o=new URL(e.href,window.location.href);this.isTrustedDomain(o.hostname)||(t.preventDefault(),window.open(o.href,"_blank","noopener,noreferrer"))}catch(e){t.preventDefault()}},{passive:!1})})}isTrustedDomain(e){const t=[window.location.hostname],o=window.cozyMode;return o&&Array.isArray(o.trustedDomains)&&o.trustedDomains.length>0&&t.push(...o.trustedDomains),t.includes(e)}injectFooter(e){if(!this.content)return;const t=document.createElement("footer");t.className="cozy-mode-footer";const o=document.createElement("div");o.className="cozy-mode-footer-meta";const n=document.createElement("p");n.textContent=e.title||"",o.appendChild(n);const i=document.createElement("p");i.textContent=window.cozyMode?.strings?.enterCozyMode||"Enter Cozy Mode",o.appendChild(i);const r=document.createElement("div");r.className="cozy-mode-footer-actions";const s=window.cozyMode?.strings?.toggleDarkMode||"Toggle dark mode",c=document.createElement("button");c.type="button",c.className="cozy-mode-control cozy-mode-theme-toggle",c.setAttribute("aria-label",s),c.textContent="ðŸŒ™",r.appendChild(c);const a=window.cozyMode?.strings?.print||"Print article",l=document.createElement("button");l.type="button",l.className="cozy-mode-control cozy-mode-print",l.setAttribute("aria-label",a),l.textContent="ðŸ–¨ï¸",r.appendChild(l),t.appendChild(o),t.appendChild(r),this.content.appendChild(t)}setupMutationObserver(e){e&&"undefined"!=typeof MutationObserver&&(this.mutationObserver=new MutationObserver(t=>{t.some(e=>Array.from(e.addedNodes).some(e=>1===e.nodeType&&("IMG"===e.tagName||e.querySelector("img"))))&&e.querySelectorAll("img").forEach(e=>{e.hasAttribute("loading")||(e.loading="lazy")})}),this.mutationObserver.observe(e,{childList:!0,subtree:!0}))}setupAccessibility(){this.modal&&(this.modal.setAttribute("aria-hidden","false"),this.modal.setAttribute("role","dialog"),this.modal.setAttribute("aria-modal","true"),this.modal.setAttribute("aria-label",window.cozyMode?.strings?.readingMode||"Reading Mode"),this.modal.setAttribute("tabindex","-1"),this.closeButton&&this.closeButton.setAttribute("aria-label",window.cozyMode?.strings?.closeCozyMode||"Close Cozy Mode"),this.controls)&&(this.controls.setAttribute("role","toolbar"),this.controls.querySelectorAll("button").forEach(e=>{e.setAttribute("tabindex","0")}))}handleResizeObserver(){"ResizeObserver"in window&&this.content&&new ResizeObserver(()=>{const e=Math.min(.9*window.innerHeight,800);this.content.style.maxHeight=`${e}px`}).observe(this.content)}handlePrefersReducedMotion(){if(!this.modal)return;const e=window.matchMedia("(prefers-reduced-motion: reduce)"),t=()=>{e.matches?this.modal.classList.add("cozy-mode-reduced-motion"):this.modal.classList.remove("cozy-mode-reduced-motion")};e.addEventListener("change",t),t()}showModal(){this.modal&&(this.modal.hidden=!1,this.modal.classList.add("active"),this.createClickOverlay(),document.body.classList.add("cozy-mode-open"),this.isActive=!0,this.handlePrefersReducedMotion(),this.handleResizeObserver(),this.trackEvent("open"))}createClickOverlay(){if(!this.modal||this.modal.parentElement?.querySelector(".cozy-mode-click-overlay"))return;const e=document.createElement("div");e.className="cozy-mode-click-overlay",this.modal.parentElement.insertBefore(e,this.modal)}closeModal(){if(!this.modal)return;this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.modal.classList.remove("active"),this.modal.setAttribute("aria-hidden","true");const e=this.modal.parentElement?.querySelector(".cozy-mode-click-overlay");e&&e.remove(),setTimeout(()=>{this.modal&&(this.modal.hidden=!0)},300),document.body.classList.remove("cozy-mode-open"),this.isActive=!1,this.savePreferences(),this.trackEvent("close"),this.previousActiveElement instanceof HTMLElement&&this.previousActiveElement.focus()}decreaseFontSize(){this.currentFontSize=Math.max(14,this.currentFontSize-2),this.applyFontSize(),this.trackEvent("font_decrease"),this.savePreferences()}increaseFontSize(){this.currentFontSize=Math.min(28,this.currentFontSize+2),this.applyFontSize(),this.trackEvent("font_increase"),this.savePreferences()}resetFontSize(){this.currentFontSize=18,this.applyFontSize(),this.trackEvent("font_reset"),this.savePreferences()}applyFontSize(){const e=this.modal?.querySelector(".cozy-mode-article-content");e&&(e.style.setProperty("font-size",`${this.currentFontSize}px`,"important"),e.querySelectorAll("p, li, span, div, a, blockquote, pre, code").forEach(e=>{e.style.setProperty("font-size",`${this.currentFontSize}px`,"important")}),e.querySelectorAll("h1").forEach(e=>{e.style.setProperty("font-size",1.8*this.currentFontSize+"px","important")}),e.querySelectorAll("h2").forEach(e=>{e.style.setProperty("font-size",1.5*this.currentFontSize+"px","important")}),e.querySelectorAll("h3").forEach(e=>{e.style.setProperty("font-size",1.3*this.currentFontSize+"px","important")}),e.querySelectorAll("h4, h5, h6").forEach(e=>{e.style.setProperty("font-size",1.1*this.currentFontSize+"px","important")}))}trackEvent(e){void 0!==window.gtag&&window.gtag("event",`cozy_mode_${e}`,{event_category:"engagement"})}trackLinkClick(e){void 0!==window.gtag&&window.gtag("event","cozy_mode_link_click",{event_category:"engagement",event_label:e})}showError(e){if(!this.modal)return;this.hideLoadingState();const t=this.modal.querySelector(".cozy-mode-error")||this.createErrorContainer();if(!t)return;t.textContent="";const o=document.createElement("div");o.className="cozy-mode-error-content";const n=document.createElement("p");n.textContent=e||window.cozyMode?.strings?.error||"An error occurred.",o.appendChild(n);const i=document.createElement("button");i.type="button",i.className="cozy-mode-control cozy-mode-close-error",i.textContent=window.cozyMode?.strings?.closeCozyMode||"Close Cozy Mode",o.appendChild(i),t.appendChild(o),t.style.display="block"}createErrorContainer(){if(!this.modal)return null;const e=document.createElement("div");return e.className="cozy-mode-error",this.modal.appendChild(e),e}showModalError(e){this.showError(e)}escapeHTML(e){return e.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}}window.yokoiCozyModeInitialized||(()=>{if("undefined"!=typeof window&&!window.yokoiCozyModeInitialized){if(!window.cozyMode){let e=0;const o=10,n=()=>{window.cozyMode?(window.yokoiCozyModeInitialized=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.yokoiCozyModeInstance||(window.yokoiCozyModeInstance=new t)},{once:!0,passive:!0}):window.yokoiCozyModeInstance||(window.yokoiCozyModeInstance=new t)):(e++,e<o&&setTimeout(n,50))};return void setTimeout(n,50)}window.yokoiCozyModeInitialized=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.yokoiCozyModeInstance||(window.yokoiCozyModeInstance=new t)},{once:!0,passive:!0}):window.yokoiCozyModeInstance||(window.yokoiCozyModeInstance=new t)}})()})();